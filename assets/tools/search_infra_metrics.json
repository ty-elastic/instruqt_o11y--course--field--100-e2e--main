{"id": "search_infra_metrics", "type": "esql", "description": "Look at relevant infrastructure metrics", "tags": ["rca"], "configuration": {"query": "FROM metrics-* \n| WHERE @timestamp >= ?search_start AND @timestamp <= ?search_end\n| WHERE host.name == ?host_name\n| WHERE system.cpu.utilization IS NOT NULL OR `system.cpu.load_average.1m` IS NOT NULL OR system.memory.utilization IS NOT NULL OR system.cpu.logical.count IS NOT NULL OR system.filesystem.utilization IS NOT NULL\n| STATS \n  mem_used = AVG(system.memory.utilization) WHERE state == \"used\", mem_buffered = AVG(system.memory.utilization) WHERE state == \"buffered\", mem_reclaimable = AVG(system.memory.utilization) WHERE state == \"slab_reclaimable\", mem_unreclaimable = AVG(system.memory.utilization) WHERE state == \"slab_unreclaimable\", \n  load_1m = AVG(`metrics.system.cpu.load_average.1m`), cpucount = MAX(system.cpu.logical.count), \n  cpu_idle = AVG(system.cpu.utilization) WHERE state == \"idle\", cpu_wait = AVG(system.cpu.utilization) WHERE state == \"wait\",\n  max_disk_usage = MAX(system.filesystem.utilization)\n  BY BUCKET(@timestamp, 1m)\n| EVAL cpu_usage = (1 - (cpu_idle + cpu_wait)) * 100\n| EVAL normalized_load = (TO_DOUBLE(load_1m) / TO_DOUBLE(cpucount)) * 100\n| EVAL mem_usage = (mem_used + mem_buffered + mem_reclaimable + mem_unreclaimable) * 100\n| EVAL disk_usage = max_disk_usage * 100\n| WHERE cpu_usage IS NOT NULL\n| KEEP cpu_usage, normalized_load, mem_usage, disk_usage, `BUCKET(@timestamp, 1m)`\n| LIMIT 1000", "params": {"search_start": {"type": "date", "description": "start of time window", "optional": false}, "search_end": {"type": "date", "description": "end of time window", "optional": false}, "host_name": {"type": "text", "description": "the host name", "optional": false}}}, "readonly": false}