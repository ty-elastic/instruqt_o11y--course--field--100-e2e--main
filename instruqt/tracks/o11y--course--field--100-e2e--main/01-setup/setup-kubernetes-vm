source /opt/workshops/elastic-retry.sh
export $(curl http://kubernetes-vm:9000/env | xargs)

export INSTRUQT_TRACK_SLUG=o11y--course--field--100-e2e--main
export REPO=us-central1-docker.pkg.dev/elastic-sa/tbekiares
export GITHUB_REPO=https://github.com/ty-elastic/instruqt_$INSTRUQT_TRACK_SLUG

# ------------- PODMAN

sudo apt-get update
sudo apt-get -y install podman

# ------------- CODE

mkdir -p /workspace/workshop
git clone $GITHUB_REPO /workspace/workshop
cd /workspace/workshop

# ------------- VIEW

source /workspace/workshop/instruqt/scripts/elastic-view.sh

# ------------- AI ASSISTANT

source /workspace/workshop/instruqt/scripts/elastic-completion.sh

# ------------- PROFILING

source /workspace/workshop/instruqt/scripts/elastic-profiling-backend.sh

# ------------- STREAMS

source /workspace/workshop/instruqt/scripts/elastic-streams.sh

# ------------- ENABLE ONE WORKFLOW

source /workspace/workshop/instruqt/scripts/elastic-workflow.sh

# ------------- ENABLE SYNTHETICS

source /workspace/workshop/instruqt/scripts/elastic-synthetics.sh

# ------------- AI PROXY

podman run --network host -d us-central1-docker.pkg.dev/elastic-sa/tbekiares/aiassistant:$INSTRUQT_TRACK_SLUG

# ------------- LOAD WORKFLOWS

get_ai_connector() {
    connectors=$(curl -X GET -s "$KIBANA_URL/api/actions/connectors" \
        -H "Authorization: Basic $ELASTICSEARCH_AUTH_BASE64" \
        -H "Content-Type: application/json" \
        -H "kbn-xsrf: true" \
        -H 'x-elastic-internal-origin: Kibana')

    CONNECTOR_ID=$(echo "$connectors" | jq -r '.[0].id // ""')

    if [[ -n "$CONNECTOR_ID" ]]; then
        echo "get_ai_connector successfully initialized: $CONNECTOR_ID"
        return 0
    else
        echo "Failed to initialize get_ai_connector. $connectors"
        return 1
    fi
}
retry_command_lin get_ai_connector

output=$(curl -s -X POST --header "Authorization: Basic $ELASTICSEARCH_AUTH_BASE64"  -H 'Content-Type: application/json' "$ELASTICSEARCH_URL/_security/api_key" -d '
{
    "name": "workflow",
    "expiration": "7d"
}
')
ELASTICSEARCH_APIKEY=$(echo $output | jq -r '.encoded')

podman run --network host $REPO/workflows:$INSTRUQT_TRACK_SLUG --ai_connector $CONNECTOR_ID --ai_proxy http://kubernetes-vm:8080 --kibana_host $KIBANA_URL --es_host $ELASTICSEARCH_URL --es_apikey $ELASTICSEARCH_APIKEY load_workflows

podman run --network host $REPO/workflows:$INSTRUQT_TRACK_SLUG --kibana_host $KIBANA_URL --es_host $ELASTICSEARCH_URL --es_apikey $ELASTICSEARCH_APIKEY load_alerts --connect_alerts True

podman run --network host $REPO/workflows:$INSTRUQT_TRACK_SLUG --kibana_host $KIBANA_URL --es_host $ELASTICSEARCH_URL --es_apikey $ELASTICSEARCH_APIKEY load_knowledge

podman run --network host $REPO/workflows:$INSTRUQT_TRACK_SLUG --kibana_host $KIBANA_URL --es_host $ELASTICSEARCH_URL --es_apikey $ELASTICSEARCH_APIKEY load_tools

podman run --network host $REPO/workflows:$INSTRUQT_TRACK_SLUG --kibana_host $KIBANA_URL --es_host $ELASTICSEARCH_URL --es_apikey $ELASTICSEARCH_APIKEY load_agents

podman run --network host $REPO/workflows:$INSTRUQT_TRACK_SLUG --kibana_host $KIBANA_URL --es_host $ELASTICSEARCH_URL --es_apikey $ELASTICSEARCH_APIKEY run_setup


# ------------- LOAD SYNTHETICS

podman run --network host $REPO/workflows:$INSTRUQT_TRACK_SLUG --kibana_host $KIBANA_URL --es_host $ELASTICSEARCH_URL --es_apikey $ELASTICSEARCH_APIKEY load_synthetics

