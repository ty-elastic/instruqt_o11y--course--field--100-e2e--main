consts:
  ai_connector: Elastic-Managed-LLM
  ai_proxy: https://tbekiares-demo-aiassistantv2-1059491012611.us-central1.run.app
  ai_timeout: 10m
  es_host: https://snap2-96da6f.es.us-west2.gcp.elastic-cloud.com
  kbn_auth: ApiKey SVdFNU81b0J4Wi1oTDdBWnR5Q3I6RmhNY0pub2pwOHFwTEFfa0d4SWtldw==
  kbn_host: https://snap2-96da6f.kb.us-west2.gcp.elastic-cloud.com
  topology_lookback_time: 1h
name: topology
enabled: true
version: '1'
description: build topology to help with correlation and RCA
tags:
- automated_observability_triage
settings:
  timeout: 20m
triggers:
- enabled: true
  type: scheduled
  with:
    every: 1h
steps:
- name: get_end_time
  type: http
  with:
    body:
      query: ROW current_date = NOW()
    headers:
      Authorization: '{{ consts.kbn_auth }}'
      Content-Type: application/json
    method: POST
    url: '{{ consts.es_host }}/_query'
- name: get_start_time
  type: http
  with:
    body:
      query: ROW current_date = NOW() - {{ consts.topology_lookback_time }}
    headers:
      Authorization: '{{ consts.kbn_auth }}'
      Content-Type: application/json
    method: POST
    url: '{{ consts.es_host }}/_query'

- name: get_service_environments
  type: http
  with:
    headers:
      Authorization: '{{ consts.kbn_auth }}'
      Content-Type: application/json
      kbn-xsrf: true
      x-elastic-internal-origin: kibana
    method: GET
    url: '{{ consts.kbn_host }}/internal/apm/environments?start={{ steps.get_start_time.output.data.values[0] }}&end={{ steps.get_end_time.output.data.values[0] }}'

- name: foreach_environment
  type: foreach
  foreach: '{{ steps.get_service_environments.output.data.environments | json }}'
  steps:

    - name: get_service_map
      type: http
      with:
        headers:
          Authorization: '{{ consts.kbn_auth }}'
          Content-Type: application/json
          kbn-xsrf: true
          x-elastic-internal-origin: kibana
        method: GET
        url: '{{ consts.kbn_host }}/internal/apm/service-map?start={{ steps.get_start_time.output.data.values[0] }}&end={{ steps.get_end_time.output.data.values[0] }}&environment={{ foreach.item }}&serviceGroup=&kuery='

    - name: host_names
      type: http
      with:
        body:
          query: |
            FROM traces-*
            | WHERE @timestamp >= "{{ steps.get_start_time.output.data.values[0] }}" AND @timestamp <= "{{ steps.get_end_time.output.data.values[0] }}"
            | WHERE k8s.namespace.name == "{{ foreach.item }}"
            | WHERE service.name IS NOT NULL AND host.name IS NOT NULL
            | STATS count = COUNT() BY service.name, host.name
            | KEEP service.name, host.name
        headers:
          Authorization: '{{ consts.kbn_auth }}'
          Content-Type: application/json
        method: POST
        url: '{{ consts.es_host }}/_query?format=txt'

    - name: get_topology1
      type: http
      with:
        body:
          connectorId: '{{ consts.ai_connector }}'
          persist: false
          instructions:
            - Output a field 'topology' which is a JSON object in node-link format.
          messages:
          - '@timestamp': now
            message:
              content: |
                Build a topology for the attached Service Map.
                # Service Map
                ```
                {{ steps.get_service_map.output.data | json }}
                ```
                For each node in the topology, use the attached Service/Host Lookup Table to add an additional field 'host.name' which is the hostname of the VM or kubernetes node or machine on which the service is running.
                # Service/Host Lookup Table
                ```
                {{ steps.host_names.output.data }}
                ```
              role: user
        headers:
          Content-Type: application/json
          kibana-auth: '{{ consts.kbn_auth }}'
          kibana-host: '{{ consts.kbn_host }}'
        method: POST
        timeout: '{{ consts.ai_timeout }}'
        url: '{{ consts.ai_proxy }}/api/observability_ai_assistant/chat/complete'

    - name: store_topology
      type: http
      with:
        body: '{"system":"{{ foreach.item }}", "topology": {{ steps.get_topology1.output.data.result.topology | json }} }'
        headers:
          Authorization: '{{ consts.kbn_auth }}'
          Content-Type: application/json
        method: POST
        timeout: 30s
        url: '{{ consts.es_host }}/workflow_topology/_doc'