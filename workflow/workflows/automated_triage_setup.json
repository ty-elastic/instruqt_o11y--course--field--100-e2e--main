{
  "version": "1",
  "name": "automated_triage_setup",
  "description": "setup state for automated triage",
  "enabled": true,
  "tags": [
    "automated_observability_triage"
  ],
  "triggers": [
    {
      "type": "manual",
      "enabled": true
    }
  ],
  "consts": {
    "ai_timeout": "10m",
    "ai_connector": "Elastic-Managed-LLM",
    "ai_proxy": "https://tbekiares-demo-aiassistant-1059491012611.us-central1.run.app",
    "kbn_host": "https://581b85187ee040c3bc41f917001ef0b7.us-west2.gcp.elastic-cloud.com",
    "es_host": "https://eb9be4b1f8e94c2fb951189307a03646.us-west2.gcp.elastic-cloud.com",
    "kbn_auth": "ApiKey U1ZyZjdaa0I4eVREU3ZXeGx6bm06cnRpNUhkMldyYlQ1NjNaTGt5UExJQQ=="
  },
  "steps": [
    {
      "name": "delete_alert_queue",
      "type": "http",
      "with": {
        "url": "{{ consts.es_host }}/workflow_alert_queue",
        "method": "DELETE",
        "headers": {
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "timeout": "30s"
      },
      "on-failure": {
        "continue": true
      }
    },
    {
      "name": "create_alert_queue",
      "type": "http",
      "with": {
        "url": "{{ consts.es_host }}/workflow_alert_queue",
        "method": "PUT",
        "headers": {
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "body": {
          "settings": {
            "number_of_shards": 1,
            "number_of_replicas": 0
          },
          "mappings": {
            "properties": {
              "alerts": {
                "type": "flattened"
              }
            }
          }
        },
        "timeout": "30s"
      }
    },
    {
      "name": "delete_case_queue",
      "type": "http",
      "with": {
        "url": "{{ consts.es_host }}/workflow_case_queue",
        "method": "DELETE",
        "headers": {
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "timeout": "30s"
      },
      "on-failure": {
        "continue": true
      }
    },
    {
      "name": "create_case_queue",
      "type": "http",
      "with": {
        "url": "{{ consts.es_host }}/workflow_case_queue",
        "method": "PUT",
        "headers": {
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "body": {
          "settings": {
            "number_of_shards": 1,
            "number_of_replicas": 0
          },
          "mappings": {
            "properties": {
              "case_id": {
                "type": "keyword"
              },
              "conversation_id": {
                "type": "keyword"
              }
            }
          }
        },
        "timeout": "30s"
      }
    },
    {
      "name": "setup_cases",
      "type": "http",
      "with": {
        "url": "{{ consts.kbn_host }}/api/cases/configure",
        "method": "POST",
        "headers": {
          "x-elastic-internal-origin": "kibana",
          "kbn-xsrf": true,
          "Content-Type": "application/json",
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "body": {
          "owner": "observability",
          "closure_type": "close-by-user",
          "connector": {
            "fields": null,
            "id": "none",
            "name": "none",
            "type": ".none"
          },
          "customFields": [
            {
              "key": "workflow_execution_id",
              "type": "text",
              "label": "workflow_execution_id",
              "required": false,
              "defaultValue": "not_available"
            },
            {
              "key": "ai_conversation_id",
              "type": "text",
              "label": "ai_conversation_id",
              "required": false,
              "defaultValue": "not_available"
            }
          ]
        },
        "timeout": "30s"
      },
      "on-failure": {
        "continue": true
      }
    },
    {
      "name": "delete_topology",
      "type": "http",
      "with": {
        "url": "{{ consts.es_host }}/workflow_topology",
        "method": "DELETE",
        "headers": {
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "timeout": "30s"
      },
      "on-failure": {
        "continue": true
      }
    },
    {
      "name": "create_topology",
      "type": "http",
      "with": {
        "url": "{{ consts.es_host }}/workflow_topology",
        "method": "PUT",
        "headers": {
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "body": {
          "settings": {
            "number_of_shards": 1,
            "number_of_replicas": 0
          },
          "mappings": {
            "properties": {
              "@timestamp": {
                "type": "date"
              },
              "system": {
                "type": "keyword"
              },
              "topology": {
                "type": "flattened"
              }
            }
          }
        },
        "timeout": "30s"
      },
      "on-failure": {
        "continue": true
      }
    },
    {
      "name": "delete_config",
      "type": "http",
      "with": {
        "url": "{{ consts.es_host }}/workflow_config",
        "method": "DELETE",
        "headers": {
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "timeout": "30s"
      },
      "on-failure": {
        "continue": true
      }
    },
    {
      "name": "create_config",
      "type": "http",
      "with": {
        "url": "{{ consts.es_host }}/workflow_config",
        "method": "PUT",
        "headers": {
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "body": {
          "settings": {
            "number_of_shards": 1,
            "number_of_replicas": 0
          },
          "mappings": {
            "properties": {
              "workflow_id": {
                "type": "keyword"
              }
            }
          }
        },
        "timeout": "30s"
      }
    },
    {
      "name": "get_workflows",
      "type": "http",
      "with": {
        "url": "{{ consts.kbn_host }}/api/workflows/search",
        "method": "POST",
        "headers": {
          "x-elastic-internal-origin": "kibana",
          "kbn-xsrf": true,
          "Content-Type": "application/json",
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "body": {
          "limit": 20,
          "page": 1,
          "query": ""
        },
        "timeout": "30s"
      }
    },
    {
      "name": "foreach_workflow",
      "type": "foreach",
      "foreach": "steps.get_workflows.output.data.results",
      "steps": [
        {
          "name": "is_case_process",
          "type": "if",
          "condition": "foreach.item.name : case_process",
          "steps": [
            {
              "name": "save_case_process_id",
              "type": "http",
              "with": {
                "url": "{{ consts.es_host }}/workflow_config/_doc/case_process_workflow",
                "method": "POST",
                "headers": {
                  "Content-Type": "application/json",
                  "Authorization": "{{ consts.kbn_auth }}"
                },
                "body": {
                  "workflow_id": "{{ foreach.item.id }}"
                },
                "timeout": "30s"
              }
            }
          ]
        },
        {
          "name": "is_alert_process",
          "type": "if",
          "condition": "foreach.item.name : alert_process",
          "steps": [
            {
              "name": "save_alert_process_id",
              "type": "http",
              "with": {
                "url": "{{ consts.es_host }}/workflow_config/_doc/alert_process_workflow",
                "method": "POST",
                "headers": {
                  "Content-Type": "application/json",
                  "Authorization": "{{ consts.kbn_auth }}"
                },
                "body": {
                  "workflow_id": "{{ foreach.item.id }}"
                },
                "timeout": "30s"
              }
            }
          ]
        },
        {
          "name": "get_executions",
          "type": "http",
          "with": {
            "url": "{{ consts.kbn_host }}/api/workflowExecutions?workflowId={{ foreach.item.id }}",
            "method": "GET",
            "headers": {
              "x-elastic-internal-origin": "kibana",
              "kbn-xsrf": true,
              "Content-Type": "application/json",
              "Authorization": "{{ consts.kbn_auth }}"
            },
            "timeout": "30s"
          },
          "on-failure": {
            "continue": true
          }
        },
        {
          "name": "foreach_execution",
          "type": "foreach",
          "foreach": "steps.get_executions.output.data.results",
          "steps": [
            {
              "name": "cancel_execution",
              "type": "http",
              "with": {
                "url": "{{ consts.kbn_host }}/api/workflowExecutions/{{ foreach.item.id }}/cancel",
                "method": "POST",
                "headers": {
                  "x-elastic-internal-origin": "kibana",
                  "kbn-xsrf": true,
                  "Content-Type": "application/json",
                  "Authorization": "{{ consts.kbn_auth }}"
                },
                "timeout": "30s"
              },
              "on-failure": {
                "continue": true
              }
            }
          ]
        }
      ]
    }
  ]
}