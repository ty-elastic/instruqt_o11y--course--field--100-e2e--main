{
  "version": "1",
  "name": "case_dequeue",
  "description": "dequeue cases serially and start processing",
  "enabled": true,
  "tags": [
    "automated_observability_triage"
  ],
  "triggers": [
    {
      "type": "manual",
      "enabled": true
    }
  ],
  "consts": {
    "ai_timeout": "10m",
    "ai_connector": "Elastic-Managed-LLM",
    "ai_proxy": "https://tbekiares-demo-aiassistant-1059491012611.us-central1.run.app",
    "kbn_host": "https://581b85187ee040c3bc41f917001ef0b7.us-west2.gcp.elastic-cloud.com",
    "es_host": "https://eb9be4b1f8e94c2fb951189307a03646.us-west2.gcp.elastic-cloud.com",
    "kbn_auth": "ApiKey U1ZyZjdaa0I4eVREU3ZXeGx6bm06cnRpNUhkMldyYlQ1NjNaTGt5UExJQQ==\"\"\""
  },
  "steps": [
    {
      "name": "get_case_process_id",
      "type": "http",
      "with": {
        "url": "{{ consts.es_host }}/workflow_config/_doc/case_process_workflow",
        "method": "GET",
        "headers": {
          "Content-Type": "application/json",
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "timeout": "30s"
      }
    },
    {
      "name": "case_process_status",
      "type": "http",
      "with": {
        "url": "{{ consts.kbn_host }}/api/workflowExecutions?workflowId={{ steps.get_case_process_id.output.data._source.workflow_id }}",
        "method": "GET",
        "headers": {
          "x-elastic-internal-origin": "kibana",
          "kbn-xsrf": true,
          "Content-Type": "application/json",
          "Authorization": "{{ consts.kbn_auth }}"
        },
        "timeout": "30s"
      }
    },
    {
      "name": "is_case_process_running",
      "type": "if",
      "condition": "steps.case_process_status.output.status : completed",
      "steps": [
        {
          "name": "is_case_process_running_debug1",
          "type": "console",
          "with": {
            "message": "workflow_alert_process running"
          }
        }
      ],
      "else": [
        {
          "name": "is_case_process_running_debug2",
          "type": "console",
          "with": {
            "message": "workflow_alert_process not running"
          }
        },
        {
          "name": "dequeue_case",
          "type": "http",
          "with": {
            "url": "{{ consts.es_host }}/workflow_case_queue/_search",
            "method": "GET",
            "headers": {
              "Content-Type": "application/json",
              "Authorization": "{{ consts.kbn_auth }}"
            },
            "body": {
              "size": "1,",
              "query": {
                "match_all": null
              },
              "_source": true
            },
            "timeout": "30s"
          }
        },
        {
          "name": "start_case_process",
          "type": "http",
          "with": {
            "url": "{{ consts.kbn_host }}/api/workflows/{{ steps.get_case_process_id.output.data._source.workflow_id }}/run",
            "method": "POST",
            "headers": {
              "x-elastic-internal-origin": "kibana",
              "kbn-xsrf": true,
              "Content-Type": "application/json",
              "Authorization": "{{ consts.kbn_auth }}"
            },
            "body": "{ \"inputs\": {\"event\": {{steps.dequeue_case.output.data.hits.hits[0]._source | json() }} } }",
            "timeout": "30s"
          }
        },
        {
          "name": "mark_case_handled",
          "type": "http",
          "with": {
            "url": "{{ consts.es_host }}/workflow_case_queue/_doc/{{steps.dequeue_case.output.data.hits.hits[0]._id}}",
            "method": "DELETE",
            "headers": {
              "Content-Type": "application/json",
              "Authorization": "{{ consts.kbn_auth }}"
            },
            "timeout": "30s"
          }
        }
      ]
    }
  ]
}