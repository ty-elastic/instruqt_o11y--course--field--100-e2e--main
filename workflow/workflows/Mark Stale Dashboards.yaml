version: '1'
name: Mark Stale Dashboards
enabled: true
triggers:
- type: manual
consts:
  ai_connector: TBD
  ai_proxy: TBD
  ai_timeout: 10m
  es_host: TBD
  kbn_auth: TBD
  kbn_host: TBD
  topology_lookback_time: 1h
steps:
- name: create_stale_tag
  type: http
  with:
    url: '{{ consts.kbn_host }}/api/saved_objects_tagging/tags/create'
    method: POST
    headers:
      Authorization: '{{ consts.kbn_auth }}'
      Content-Type: application/json
      kbn-xsrf: true
      x-elastic-internal-origin: kibana
    body:
      name: 'stale_{{ "now" | date: "%Y-%m-%d %H:%M:%S" }}'
      description: 'marked stale @ {{ "now" | date: "%Y-%m-%d %H:%M:%s" }}'
      color: '#FF0000'
    timeout: 30s

- name: dashboard_usage
  type: http
  with:
    url: '{{ consts.es_host }}/_query?format=json'
    method: POST
    headers:
      Authorization: '{{ consts.kbn_auth }}'
      Content-Type: application/json
    body:
      query: |
        FROM .kibana_usage_counters, .kibana_analytics* METADATA _id  
        | WHERE `dashboard.title` is not null OR `usage-counter.counterType` == "viewed"
        | WHERE managed == false
        | DISSECT _id "dashboard:%{dashboard_id}"
        | EVAL dashboard_id=CASE(dashboard.title IS NOT NULL,dashboard_id, `usage-counter.counterName` )
        | STATS max_timestamp=MAX(updated_at), namespace = VALUES(namespaces), dashboard_title=MAX(dashboard.title), views=SUM(`usage-counter.count`) WHERE `usage-counter.counterType` == "viewed" BY dashboard_id
        //| WHERE max_timestamp <= NOW()-1h
        | WHERE dashboard_title LIKE "Old*"
        | EVAL views=CASE(views IS NULL,0,TO_INTEGER(views))
        //| WHERE views == 0
        | KEEP dashboard_id
    timeout: 30s
- name: foreach_dashboard
  type: foreach
  foreach: '{{ steps.dashboard_usage.output.data.values | json }}'
  steps:
  - name: get_dashboard
    type: http
    with:
      url: '{{ consts.kbn_host }}/api/dashboards/dashboard/{{ foreach.item }}'
      method: GET
      headers:
        Authorization: '{{ consts.kbn_auth }}'
        Content-Type: application/json
        kbn-xsrf: true
        x-elastic-internal-origin: kibana
      timeout: 30s
  - name: modify_dashboard
    type: http
    with:
      url: '{{ consts.kbn_host }}/api/content_management/rpc/update'
      method: POST
      body: |
        {
          "contentTypeId": "{{ steps.get_dashboard.output.data.type }}", 
          "id": "{{ steps.get_dashboard.output.data.id }}", 
          "data": { 
            "controlGroupInput": {{ steps.get_dashboard.output.data.data.controlGroupInput  | json | default: '{}' }}, 
            "query": {{ steps.get_dashboard.output.data.data.query | json | default: '{}' }}, 
            "options": {{ steps.get_dashboard.output.data.data.options | json | default: '{}' }}, 
            "panels": {{ steps.get_dashboard.output.data.data.panels | json | default: '[]' }},
            {% assign new_tags = steps.get_dashboard.output.data.data.tags | push: steps.create_stale_tag.output.data.tag.id %} 
            "tags": {{ new_tags | json  }}, 
            "title": "{{ steps.get_dashboard.output.data.data.title  }}", 
            "description": "" 
          }, 
          "options": { 
            "mergeAttributes": false,
            "references": {{ steps.get_dashboard.output.data.data.references | json }} 
          },
          "version": 1
        }
      headers:
        Authorization: '{{ consts.kbn_auth }}'
        Content-Type: application/json
        kbn-xsrf: true
        x-elastic-internal-origin: kibana
      timeout: 30s
    on-failure:
      continue: true
