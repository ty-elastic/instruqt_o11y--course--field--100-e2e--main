{
  "version": "1",
  "name": "alert_process",
  "description": "Process o11y alerts and correlate to cases",
  "enabled": true,
  "tags": [
    "automated_observability_triage"
  ],
  "triggers": [
    {
      "type": "alert",
      "enabled": true
    }
  ],
  "consts": {
    "ai_timeout": "10m",
    "ai_connector": "Elastic-Managed-LLM",
    "ai_proxy": "https://tbekiares-demo-aiassistant-1059491012611.us-central1.run.app",
    "kbn_host": "https://581b85187ee040c3bc41f917001ef0b7.us-west2.gcp.elastic-cloud.com",
    "es_host": "https://eb9be4b1f8e94c2fb951189307a03646.us-west2.gcp.elastic-cloud.com",
    "kbn_auth": "ApiKey U1ZyZjdaa0I4eVREU3ZXeGx6bm06cnRpNUhkMldyYlQ1NjNaTGt5UExJQQ=="
  },
  "steps": [
    {
      "name": "debug1",
      "type": "console",
      "with": {
        "message": "{{ event | json(2)}}"
      }
    },
    {
      "name": "foreach_alert_in_event",
      "type": "foreach",
      "foreach": "event.alerts",
      "steps": [
        {
          "name": "foreach_alert_in_event_debug",
          "type": "console",
          "with": {
            "message": "{{ foreach.item | json(2)}}"
          }
        },
        {
          "name": "get_topology",
          "type": "http",
          "with": {
            "url": "{{ consts.es_host }}/workflow_topology/_search",
            "method": "GET",
            "headers": {
              "Content-Type": "application/json",
              "Authorization": "{{ consts.kbn_auth }}"
            },
            "body": {
              "size": 0,
              "aggs": {
                "unique_field_buckets": {
                  "terms": {
                    "field": "system.keyword",
                    "size": 100
                  },
                  "aggs": {
                    "latest_document": {
                      "top_hits": {
                        "size": 1,
                        "sort": [
                          {
                            "@timestamp": null,
                            "order": "desc"
                          }
                        ],
                        "_source": {
                          "includes": [
                            "system",
                            "topology"
                          ]
                        }
                      }
                    }
                  }
                }
              }
            },
            "timeout": "30s"
          }
        },
        {
          "name": "get_cases",
          "type": "kibana.request",
          "with": {
            "method": "GET",
            "path": "/api/cases/_find?status=open",
            "headers": {
              "Authorization": "{{ consts.kbn_auth }}"
            }
          }
        },
        {
          "name": "correlate_to_case",
          "type": "http",
          "with": {
            "url": "{{ consts.ai_proxy }}/api/observability_ai_assistant/chat/complete",
            "method": "POST",
            "headers": {
              "Content-Type": "application/json",
              "kibana-host": "{{ consts.kbn_host }}",
              "kibana-auth": "{{ consts.kbn_auth }}"
            },
            "body": {
              "persist": false,
              "connectorId": "{{ consts.ai_connector }}",
              "instructions": [
                "Look at each case provided, consider the comments, any attached alerts (including correlating factors like time, host, system), and the provided system topology. Decide which case, if any, this new alert is likely related to. If it is related, output a field 'case_id' with the value of the related case and a field 'relation' with a summary of how it is related. If it is not related to any open case, output only a field 'case_id' with a value of 'NONE'."
              ],
              "messages": [
                {
                  "@timestamp": "now",
                  "message": {
                    "role": "user",
                    "content": "<cases>\n  {{ steps.get_cases.output.cases | json(2) }}\n</cases>\n<alert>\n  {{ foreach.item | json(2)}}\n</alert>\n<topology>\n  {{ steps.get_topology.output.data.hits.hits | json(2) }}\n</topology\n"
                  }
                }
              ]
            },
            "timeout": "{{ consts.ai_timeout }}"
          }
        },
        {
          "name": "new_or_update_case",
          "type": "if",
          "condition": "steps.correlate_to_case.output.data.case_id : NONE",
          "steps": [
            {
              "name": "create_alert_details",
              "type": "http",
              "with": {
                "url": "{{ consts.ai_proxy }}/api/observability_ai_assistant/chat/complete",
                "method": "POST",
                "headers": {
                  "Content-Type": "application/json",
                  "kibana-host": "{{ consts.kbn_host }}",
                  "kibana-auth": "{{ consts.kbn_auth }}"
                },
                "body": {
                  "persist": true,
                  "connectorId": "{{ consts.ai_connector }}",
                  "instructions": [
                    "We will be creating an incident case for handling this new alert. Output a field called 'title' that summarizes the alert in a few words, a field called 'trigger' that provides a detailed summary of the alert, and a field called 'severity' with a value of 'low', 'medium', 'high', or 'critical' based on your analysis?"
                  ],
                  "messages": [
                    {
                      "@timestamp": "now",
                      "message": {
                        "role": "user",
                        "content": "<alert>\n  {{ foreach.item | json(2)}}\n</alert>\n"
                      }
                    }
                  ]
                },
                "timeout": "{{ consts.ai_timeout }}"
              }
            },
            {
              "name": "create_case",
              "type": "kibana.request",
              "with": {
                "method": "POST",
                "path": "/api/cases",
                "body": {
                  "owner": "observability",
                  "title": "{{ steps.create_alert_details.output.data.title }}",
                  "description": "{{ steps.create_alert_details.output.data.trigger }}\n",
                  "tags": [
                    "automated_observability_triage"
                  ],
                  "settings": {
                    "syncAlerts": true
                  },
                  "severity": "{{ steps.create_alert_details.output.data.severity }}",
                  "connector": {
                    "fields": null,
                    "id": "none",
                    "name": "none",
                    "type": ".none"
                  },
                  "customFields": [
                    {
                      "key": "workflow_execution_id",
                      "type": "text",
                      "value": "not_available"
                    },
                    {
                      "key": "ai_conversation_id",
                      "type": "text",
                      "value": "{{ steps.create_alert_details.output.data.conversation_id }}"
                    }
                  ]
                }
              }
            },
            {
              "name": "add_alert_to_case",
              "type": "kibana.request",
              "with": {
                "method": "POST",
                "path": "/api/cases/{{ steps.create_case.output.id }}/comments",
                "body": {
                  "type": "alert",
                  "alertId": "{{ foreach.item.id }}",
                  "index": ".alerts-security.alerts-default",
                  "rule": {
                    "name": "{{ foreach.item.rule.name }}",
                    "id": "{{ foreach.item.rule.uuid }}"
                  },
                  "owner": "observability"
                },
                "headers": {
                  "kbn-xsrf": true,
                  "Content-Type": "application/json",
                  "Authorization": "{{ consts.kbn_auth }}"
                }
              }
            },
            {
              "name": "queue_new_case",
              "type": "http",
              "with": {
                "url": "{{ consts.es_host }}/workflow_case_queue/_doc",
                "method": "POST",
                "headers": {
                  "Content-Type": "application/json",
                  "Authorization": "{{ consts.kbn_auth }}"
                },
                "body": {
                  "case_id": "{{ steps.create_case.output.id }}"
                },
                "timeout": "30s"
              }
            }
          ],
          "else": [
            {
              "name": "add_alert_to_existing_case",
              "type": "kibana.request",
              "with": {
                "method": "POST",
                "path": "/api/cases/{{ steps.correlate_to_case.output.data.case_id }}/comments",
                "body": {
                  "type": "alert",
                  "alertId": "{{ foreach.item.id }}",
                  "index": ".alerts-security.alerts-default",
                  "rule": {
                    "name": "{{ foreach.item.rule.name }}",
                    "id": "{{ foreach.item.rule.uuid }}"
                  },
                  "owner": "observability"
                },
                "headers": {
                  "kbn-xsrf": true,
                  "Content-Type": "application/json",
                  "Authorization": "{{ consts.kbn_auth }}"
                }
              }
            },
            {
              "name": "add_comment_to_existing_case",
              "type": "kibana.request",
              "with": {
                "method": "POST",
                "path": "/api/cases/{{ steps.correlate_to_case.output.data.case_id }}/comments",
                "body": {
                  "type": "user",
                  "owner": "observability",
                  "comment": "correlated alert '{{ foreach.item.reason }}'. {{ steps.correlate_to_case.output.data.relation }}"
                },
                "headers": {
                  "kbn-xsrf": true,
                  "Content-Type": "application/json",
                  "Authorization": "{{ consts.kbn_auth }}"
                }
              }
            },
            {
              "name": "queue_existing_case",
              "type": "http",
              "with": {
                "url": "{{ consts.es_host }}/workflow_case_queue/_doc",
                "method": "POST",
                "headers": {
                  "Content-Type": "application/json",
                  "Authorization": "{{ consts.kbn_auth }}"
                },
                "body": {
                  "case_id": "{{ steps.correlate_to_case.output.data.case_id }}"
                },
                "timeout": "30s"
              }
            }
          ]
        },
        {
          "name": "mute_alert",
          "type": "kibana.request",
          "with": {
            "method": "POST",
            "path": "/api/alerting/rule/{{ foreach.item.rule.uuid }}/alert/{{ foreach.item.id }}/_mute",
            "body": null,
            "headers": {
              "kbn-xsrf": "string",
              "Content-Type": "application/json",
              "Authorization": "{{ consts.kbn_auth }}"
            }
          },
          "on-failure": {
            "continue": true
          }
        }
      ]
    }
  ]
}